print("=== AUTO TRADE BY COINS - STANDALONE EDITION ===\n")

-- ============================================================================
--                              INITIALIZATION
-- ============================================================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

print("üîÑ Initializing modules...")

-- Get Replion
local replionModule = ReplicatedStorage.Packages._Index:FindFirstChild("ytrev_replion@2.0.0-rc.3")
if not replionModule then
    error("‚ùå Replion module not found")
end
local Replion = require(replionModule.replion)
local Data = Replion.Client:WaitReplion("Data")

-- Get Net module
local Net = ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net

-- Get remotes
local TradeRemote = Net["RF/InitiateTrade"]
local FavoriteRemote = Net["RE/FavoriteItem"]
local UnequipRemote = Net["RE/UnequipItem"]

-- Get utilities
local ItemUtility = nil
local PlayerStatsUtility = nil

local success1, result1 = pcall(function()
    return require(ReplicatedStorage.Shared.ItemUtility)
end)
if success1 then
    ItemUtility = result1
    print("‚úÖ ItemUtility loaded")
else
    error("‚ùå ItemUtility not found")
end

local success2, result2 = pcall(function()
    return require(ReplicatedStorage.Shared.PlayerStatsUtility)
end)
if success2 then
    PlayerStatsUtility = result2
    print("‚úÖ PlayerStatsUtility loaded")
else
    warn("‚ö†Ô∏è PlayerStatsUtility not found - using fallback")
end

print("")

-- ============================================================================
--                              CONFIGURATION
-- ============================================================================

local CONFIG = {
    -- CHANGE THESE VALUES!
    RECEIVER_USER_ID = 9850456083,  -- User ID of receiver account
    TARGET_COINS = 50000000,        -- Target coins to send (50M)
    
    -- Trading Settings
    TRADE_DELAY = 5,                -- Seconds between trades
    RETRY_DELAY = 1,                -- Seconds before retry
    MAX_RETRIES = 2,                -- Max retries per fish
    TIMEOUT = 10,                   -- Timeout for trade confirmation
    
    -- Auto-Accept Settings (for receiver)
    AUTO_ACCEPT_ENABLED = true,     -- Enable auto-accept for receiver
    
    -- Notification Settings
    NOTIFY_YUMMU_AUTO = true,       -- Send notifications to Yummu Auto
}

local STATE = {
    isReceiver = false,
    isWorker = false,
    currentUserId = LocalPlayer.UserId,
    currentUsername = LocalPlayer.Name,
    trading = false,
    totalSent = 0,
    totalSuccess = 0,
    totalFailed = 0,
    startTime = 0,
}

print(string.rep("=", 70))
print("‚öôÔ∏è  CONFIGURATION")
print(string.rep("=", 70))
print("")
print(string.format("Receiver User ID: %d", CONFIG.RECEIVER_USER_ID))
print(string.format("Target Coins: %s", tostring(CONFIG.TARGET_COINS):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")))
print(string.format("Trade Delay: %ds", CONFIG.TRADE_DELAY))
print(string.format("Max Retries: %d", CONFIG.MAX_RETRIES))
print("")
print(string.rep("=", 70))
print("")

-- ============================================================================
--                          UTILITY FUNCTIONS
-- ============================================================================

local function formatNumber(num)
    return tostring(num):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
end

local function itemExists(uuid)
    local items = Data:GetExpect({ "Inventory", "Items" }) or {}
    for _, item in ipairs(items) do
        if item.UUID == uuid then
            return true
        end
    end
    return false
end

local function waitForTradeComplete(uuid, timeout)
    local startTime = tick()
    while tick() - startTime < timeout do
        if not itemExists(uuid) then
            return true
        end
        wait(0.2)
    end
    return false
end

local function getSellPrice(basePrice)
    if not basePrice or basePrice <= 0 then
        return 0
    end
    
    if PlayerStatsUtility and PlayerStatsUtility.GetPlayerModifiers and PlayerStatsUtility.GetSellPrice then
        local success, result = pcall(function()
            local modifiers = PlayerStatsUtility:GetPlayerModifiers(LocalPlayer)
            return PlayerStatsUtility:GetSellPrice(basePrice, modifiers)
        end)
        
        if success and result then
            return result
        end
    end
    
    return basePrice
end

local function notifyYummyAuto(message, isCompleted)
    if not CONFIG.NOTIFY_YUMMU_AUTO then return end
    
    local status = isCompleted and "Completed-" or "Status-"
    local fullMessage = status .. message
    
    print(string.format("\nüìù Yummu Auto Notification: %s", fullMessage))
end

-- ============================================================================
--                          STEP 1: VALIDATE USER
-- ============================================================================

local function validateUser()
    print(string.rep("=", 70))
    print("üë§ USER VALIDATION")
    print(string.rep("=", 70))
    print("")
    print("Current User ID:", STATE.currentUserId)
    print("Username:", STATE.currentUsername)
    print("")
    
    if STATE.currentUserId == CONFIG.RECEIVER_USER_ID then
        STATE.isReceiver = true
        print("‚úÖ Role: RECEIVER (Auto Accept Mode)")
        print("")
        return "receiver"
    else
        STATE.isWorker = true
        print("‚úÖ Role: WORKER (Trade Mode)")
        print(string.format("   Target: User ID %d", CONFIG.RECEIVER_USER_ID))
        print(string.format("   Target Coins: %s", formatNumber(CONFIG.TARGET_COINS)))
        print("")
        return "worker"
    end
end

-- ============================================================================
--                          AUTO ACCEPT (RECEIVER)
-- ============================================================================

local function startAutoAccept()
    print(string.rep("=", 70))
    print("ü§ñ AUTO ACCEPT TRADE - ACTIVATED")
    print(string.rep("=", 70))
    print("")
    print("Waiting for trade requests...")
    print("This account will auto-accept all trades")
    print("")
    
    notifyYummyAuto("ReceiverMode-AutoAcceptActive", false)
    
    local acceptCount = 0
    
    task.spawn(function()
        while true do
            wait(0.5)
            
            pcall(function()
                local prompt = LocalPlayer.PlayerGui:FindFirstChild("Prompt")
                
                if prompt and prompt:FindFirstChild("Blackout") then
                    local blackout = prompt.Blackout
                    
                    if blackout:FindFirstChild("Options") then
                        local yesButton = blackout.Options:FindFirstChild("Yes")
                        
                        if yesButton then
                            acceptCount = acceptCount + 1
                            print(string.format("[%s] ‚úÖ Auto accepting trade #%d", 
                                os.date("%H:%M:%S"), acceptCount))
                            
                            local pos = yesButton.AbsolutePosition
                            local size = yesButton.AbsoluteSize
                            local x = pos.X + size.X / 2
                            local y = pos.Y + size.Y / 2 + 50
                            
                            game:GetService("VirtualInputManager"):SendMouseButtonEvent(x, y, 0, true, game, 1)
                            wait(0.03)
                            game:GetService("VirtualInputManager"):SendMouseButtonEvent(x, y, 0, false, game, 1)
                            
                            wait(1)
                        end
                    end
                end
            end)
        end
    end)
    
    print("‚úÖ Auto Accept is running in background")
    print("‚úÖ This window will stay open - just leave it running")
    print("")
end

-- ============================================================================
--                    STEP 2: UNFAVORITE ALL FISH
-- ============================================================================

local function unfavoriteAllFish()
    print(string.rep("=", 70))
    print("üíî STEP 1: UNFAVORITING ALL FISH")
    print(string.rep("=", 70))
    print("")
    
    local items = Data:GetExpect({ "Inventory", "Items" }) or {}
    local favoritedCount = 0
    local unfavoritedCount = 0
    
    for _, item in ipairs(items) do
        if item.Favorited then
            local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
            if itemData and itemData.Data and itemData.Data.Type == "Fish" then
                favoritedCount = favoritedCount + 1
            end
        end
    end
    
    if favoritedCount == 0 then
        print("‚úÖ No favorited fish found")
        print("")
        return true
    end
    
    print(string.format("Found %d favorited fish", favoritedCount))
    print("Unfavoriting...\n")
    
    for _, item in ipairs(items) do
        if item.Favorited then
            local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
            
            if itemData and itemData.Data and itemData.Data.Type == "Fish" then
                local success = pcall(function()
                    FavoriteRemote:FireServer(item.UUID)
                end)
                
                if success then
                    unfavoritedCount = unfavoritedCount + 1
                    print(string.format("   [%d/%d] Unfavorited: %s", 
                        unfavoritedCount, favoritedCount, itemData.Data.Name))
                end
                
                wait(0.05)
            end
        end
    end
    
    wait(0.5)
    
    print("")
    print(string.rep("=", 70))
    print(string.format("‚úÖ Unfavorited %d fish", unfavoritedCount))
    print(string.rep("=", 70))
    print("")
    
    return true
end

-- ============================================================================
--                    STEP 3: UNEQUIP ALL ITEMS
-- ============================================================================

local function unequipAllItems()
    print(string.rep("=", 70))
    print("üîì STEP 2: UNEQUIPPING ALL ITEMS")
    print(string.rep("=", 70))
    print("")
    
    local items = Data:GetExpect({ "Inventory", "Items" }) or {}
    local unequippedCount = 0
    
    for _, item in ipairs(items) do
        if item.Equipped then
            pcall(function()
                UnequipRemote:FireServer(item.UUID)
                unequippedCount = unequippedCount + 1
            end)
            wait(0.05)
        end
    end
    
    print(string.format("‚úÖ Unequipped %d items", unequippedCount))
    print("")
    
    return true
end

-- ============================================================================
--                    STEP 4: GET FISH FOR COINS
-- ============================================================================

local function getFishForCoins()
    print(string.rep("=", 70))
    print("üí∞ STEP 3: CALCULATING FISH VALUES")
    print(string.rep("=", 70))
    print("")
    
    local items = Data:GetExpect({ "Inventory", "Items" }) or {}
    local fishList = {}
    
    print(string.format("üì¶ Total items in inventory: %d", #items))
    print("")
    
    local debugStats = {
        totalItems = #items,
        fishItems = 0,
        favoritedFish = 0,
        equippedFish = 0,
        tradeableFish = 0,
        nonFish = 0
    }
    
    for _, item in ipairs(items) do
        local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
        
        if itemData and itemData.Data then
            if itemData.Data.Type == "Fish" then
                debugStats.fishItems = debugStats.fishItems + 1
                
                if item.Favorited then
                    debugStats.favoritedFish = debugStats.favoritedFish + 1
                elseif item.Equipped then
                    debugStats.equippedFish = debugStats.equippedFish + 1
                else
                    debugStats.tradeableFish = debugStats.tradeableFish + 1
                    
                    local basePrice = itemData.Data.Price or 0
                    local sellPrice = getSellPrice(basePrice)
                    
                    table.insert(fishList, {
                        UUID = item.UUID,
                        Name = itemData.Data.Name,
                        Price = sellPrice,
                        Id = item.Id
                    })
                end
            else
                debugStats.nonFish = debugStats.nonFish + 1
            end
        end
    end
    
    print("üìä Inventory Analysis:")
    print(string.format("   Total Items: %d", debugStats.totalItems))
    print(string.format("   Fish Items: %d", debugStats.fishItems))
    print(string.format("   - Favorited: %d", debugStats.favoritedFish))
    print(string.format("   - Equipped: %d", debugStats.equippedFish))
    print(string.format("   - Tradeable: %d", debugStats.tradeableFish))
    print(string.format("   Non-Fish: %d", debugStats.nonFish))
    print("")
    
    table.sort(fishList, function(a, b)
        return a.Price > b.Price
    end)
    
    print(string.format("Found %d tradeable fish", #fishList))
    print("")
    
    if #fishList > 0 then
        print("Top 10 most expensive fish:")
        for i = 1, math.min(10, #fishList) do
            local fish = fishList[i]
            print(string.format("   %2d. %-30s %s coins", i, fish.Name, formatNumber(fish.Price)))
        end
    else
        print("‚ö†Ô∏è  No tradeable fish found!")
        if debugStats.favoritedFish > 0 then
            print(string.format("   Hint: You have %d favorited fish. Unfavorite them first.", debugStats.favoritedFish))
        end
        if debugStats.equippedFish > 0 then
            print(string.format("   Hint: You have %d equipped fish. Unequip them first.", debugStats.equippedFish))
        end
    end
    
    print("")
    
    local totalValue = 0
    for _, fish in ipairs(fishList) do
        totalValue = totalValue + fish.Price
    end
    
    print(string.format("Total inventory value: %s coins", formatNumber(totalValue)))
    print("")
    
    return fishList, totalValue
end

-- ============================================================================
--                    STEP 5: SELECT FISH FOR TARGET
-- ============================================================================

local function selectFishForTarget(fishList, targetCoins)
    print(string.rep("=", 70))
    print("üéØ STEP 4: SELECTING FISH FOR TARGET")
    print(string.rep("=", 70))
    print("")
    
    print(string.format("Target: %s coins", formatNumber(targetCoins)))
    print("")
    
    local selected = {}
    local totalValue = 0
    
    for _, fish in ipairs(fishList) do
        if totalValue >= targetCoins then
            break
        end
        
        table.insert(selected, fish)
        totalValue = totalValue + fish.Price
    end
    
    print(string.format("Selected %d fish", #selected))
    print(string.format("Total value: %s coins", formatNumber(totalValue)))
    
    if totalValue < targetCoins then
        print(string.format("‚ö†Ô∏è  Warning: Only %.1f%% of target", (totalValue/targetCoins)*100))
    else
        print(string.format("‚úÖ Reached %.1f%% of target", (totalValue/targetCoins)*100))
    end
    
    print("")
    
    return selected, totalValue
end

-- ============================================================================
--                    STEP 6: TRADE FISH
-- ============================================================================

local function tradeSingleFish(userId, fish, index, total)
    local retries = 0
    
    while retries <= CONFIG.MAX_RETRIES do
        local attempt = retries + 1
        print(string.format("[%d/%d] %s (%s coins) - Attempt %d/%d", 
            index, total, fish.Name, formatNumber(fish.Price), attempt, CONFIG.MAX_RETRIES + 1))
        
        local success, result = pcall(function()
            return TradeRemote:InvokeServer(userId, fish.UUID)
        end)
        
        if not success then
            print("        ‚ùå ERROR:", tostring(result))
            retries = retries + 1
            if retries <= CONFIG.MAX_RETRIES then
                wait(CONFIG.RETRY_DELAY)
            end
        elseif result == true then
            print("        ‚è≥ Confirming...")
            local confirmed = waitForTradeComplete(fish.UUID, CONFIG.TIMEOUT)
            
            if confirmed then
                print("        ‚úÖ SUCCESS")
                STATE.totalSent = STATE.totalSent + fish.Price
                STATE.totalSuccess = STATE.totalSuccess + 1
                return true
            else
                if not itemExists(fish.UUID) then
                    print("        ‚úÖ SUCCESS (Item gone)")
                    STATE.totalSent = STATE.totalSent + fish.Price
                    STATE.totalSuccess = STATE.totalSuccess + 1
                    return true
                else
                    retries = retries + 1
                    if retries <= CONFIG.MAX_RETRIES then
                        wait(CONFIG.RETRY_DELAY)
                    end
                end
            end
        else
            print("        ‚ùå FAILED (Server returned false)")
            STATE.totalFailed = STATE.totalFailed + 1
            return false
        end
    end
    
    print("        ‚ùå FAILED after", CONFIG.MAX_RETRIES + 1, "attempts")
    STATE.totalFailed = STATE.totalFailed + 1
    return false
end

local function tradeAllFish(selectedFish)
    print(string.rep("=", 70))
    print("üöÄ STEP 5: STARTING TRADE")
    print(string.rep("=", 70))
    print("")
    print(string.format("Total fish to trade: %d", #selectedFish))
    print(string.format("Delay per trade: %ds", CONFIG.TRADE_DELAY))
    print(string.format("Estimated time: ~%d minutes", 
        math.ceil((#selectedFish * CONFIG.TRADE_DELAY) / 60)))
    print("")
    
    notifyYummyAuto(string.format("TradingStarted-%dfish", #selectedFish), false)
    
    STATE.trading = true
    STATE.totalSent = 0
    STATE.totalSuccess = 0
    STATE.totalFailed = 0
    STATE.startTime = tick()
    
    for i, fish in ipairs(selectedFish) do
        if not STATE.trading then
            print("\n‚ö†Ô∏è Trade stopped by user")
            notifyYummyAuto("TradeStopped-ByUser", true)
            break
        end
        
        tradeSingleFish(CONFIG.RECEIVER_USER_ID, fish, i, #selectedFish)
        
        if i % 10 == 0 or i == #selectedFish then
            print("")
            print(string.format("üìä Progress: %d/%d (%.1f%%)", i, #selectedFish, (i/#selectedFish)*100))
            print(string.format("üí∞ Sent: %s / %s coins", 
                formatNumber(STATE.totalSent), formatNumber(CONFIG.TARGET_COINS)))
            print("")
            
            notifyYummyAuto(string.format("Progress-%d%%-%scoins", 
                math.floor((i/#selectedFish)*100), formatNumber(STATE.totalSent)), false)
        end
        
        if i < #selectedFish then
            wait(CONFIG.TRADE_DELAY)
        end
    end
    
    local duration = math.floor(tick() - STATE.startTime)
    local minutes = math.floor(duration / 60)
    local seconds = duration % 60
    
    STATE.trading = false
    
    return duration, minutes, seconds
end

-- ============================================================================
--                    STEP 7: CHECK INVENTORY
-- ============================================================================

local function checkInventoryEmpty()
    print(string.rep("=", 70))
    print("üì¶ CHECKING INVENTORY STATUS")
    print(string.rep("=", 70))
    print("")
    
    local items = Data:GetExpect({ "Inventory", "Items" }) or {}
    local fishCount = 0
    
    for _, item in ipairs(items) do
        local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
        if itemData and itemData.Data and itemData.Data.Type == "Fish" then
            fishCount = fishCount + 1
        end
    end
    
    if fishCount == 0 then
        print("‚úÖ INVENTORY IS EMPTY - All fish traded!")
        print("")
        return true
    else
        print(string.format("‚ö†Ô∏è  Remaining fish: %d", fishCount))
        print("")
        return false
    end
end

-- ============================================================================
--                    FINAL SUMMARY
-- ============================================================================

local function showFinalSummary(duration, minutes, seconds)
    print(string.rep("=", 70))
    print("üéâ TRADE COMPLETED")
    print(string.rep("=", 70))
    print("")
    print("üìä Statistics:")
    print(string.format("   ‚úÖ Success:      %d", STATE.totalSuccess))
    print(string.format("   ‚ùå Failed:       %d", STATE.totalFailed))
    print(string.format("   üì¶ Total:        %d", STATE.totalSuccess + STATE.totalFailed))
    print("")
    print(string.format("üí∞ Coins Sent:      %s", formatNumber(STATE.totalSent)))
    print(string.format("üéØ Target:          %s", formatNumber(CONFIG.TARGET_COINS)))
    print(string.format("üìà Achievement:     %.1f%%", (STATE.totalSent/CONFIG.TARGET_COINS)*100))
    print("")
    print(string.format("‚è±Ô∏è  Duration:        %dm %ds", minutes, seconds))
    if STATE.totalSuccess > 0 then
        print(string.format("‚è±Ô∏è  Avg per fish:    %.1fs", duration / STATE.totalSuccess))
    end
    print(string.rep("=", 70))
    print("")
    
    local isEmpty = checkInventoryEmpty()
    
    if isEmpty then
        print("‚úÖ All items traded successfully!")
        notifyYummyAuto(string.format("TradeCompleted-%scoins", formatNumber(STATE.totalSent)), true)
        
        print("\n‚úÖ DONE! You can now:")
        print("   1. Switch to next bot manually")
        print("   2. Or run script again on another account")
        print("   3. Or check receiver account for items")
    else
        print("‚ö†Ô∏è  Some items remain in inventory")
        notifyYummyAuto(string.format("TradePartial-%scoins", formatNumber(STATE.totalSent)), true)
    end
    
    print("")
end

-- ============================================================================
--                          MAIN WORKFLOW
-- ============================================================================

local function startWorkerMode()
    print(string.rep("=", 70))
    print("ü§ñ WORKER MODE - STANDALONE TRADING")
    print(string.rep("=", 70))
    print("")
    
    notifyYummyAuto("WorkerMode-Starting", false)
    
    local step1 = unfavoriteAllFish()
    if not step1 then
        print("‚ùå Failed at Step 1")
        notifyYummyAuto("Failed-UnfavoriteFish", true)
        return
    end
    
    local step2 = unequipAllItems()
    if not step2 then
        print("‚ùå Failed at Step 2")
        notifyYummyAuto("Failed-UnequipItems", true)
        return
    end
    
    wait(1)
    
    local fishList, totalValue = getFishForCoins()
    
    if #fishList == 0 then
        print("‚ùå No tradeable fish found!")
        print("\nüí° Make sure:")
        print("   - You have fish in inventory")
        print("   - Fish are not favorited")
        print("   - Fish are not equipped")
        print("")
        notifyYummyAuto("NoFishFound-Skipping", true)
        return
    end
    
    local selectedFish, selectedValue = selectFishForTarget(fishList, CONFIG.TARGET_COINS)
    
    if #selectedFish == 0 then
        print("‚ùå No fish selected!")
        notifyYummyAuto("NoFishSelected-Skipping", true)
        return
    end
    
    print("‚è∏Ô∏è  Ready to start trading")
    print(string.format("   Fish to trade: %d", #selectedFish))
    print(string.format("   Total value: %s coins", formatNumber(selectedValue)))
    print(string.format("   To receiver: User ID %d", CONFIG.RECEIVER_USER_ID))
    print("")
    print("Starting in 10 seconds...")
    print("üí° To stop: Press Ctrl+C or call StopAutoTrade()")
    print("")
    
    notifyYummyAuto(string.format("PreparingTrade-%dfish-%scoins", 
        #selectedFish, formatNumber(selectedValue)), false)
    
    wait(10)
    
    local duration, minutes, seconds = tradeAllFish(selectedFish)
    
    showFinalSummary(duration, minutes, seconds)
end

-- ============================================================================
--                          START SCRIPT
-- ============================================================================

print(string.rep("=", 70))
print("üöÄ AUTO TRADE BY COINS - STANDALONE EDITION")
print(string.rep("=", 70))
print("")
print("‚ÑπÔ∏è  This script runs WITHOUT API server")
print("   - No HTTP requests")
print("   - Pure local operation")
print("   - Manual bot switching")
print("")
print(string.rep("=", 70))
print("")

local userRole = validateUser()

if userRole == "receiver" then
    if CONFIG.AUTO_ACCEPT_ENABLED then
        startAutoAccept()
    else
        print("‚ÑπÔ∏è  Auto-accept is disabled in config")
        print("   You'll need to accept trades manually")
        print("")
    end
elseif userRole == "worker" then
    startWorkerMode()
end

-- Stop function
getgenv().StopAutoTrade = function()
    STATE.trading = false
    notifyYummyAuto("StoppedByUser", true)
    print("\nüõë Auto trade stopped\n")
end

print("üí° Commands:")
print("   StopAutoTrade() - Stop trading immediately")
print("")
